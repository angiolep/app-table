<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../app-input/app-input.html">
<!--
  ## AppTable

  A web-component table wrapper which provides data grid with fixed headers.

  ### Usage
  ```bash
    bower install angiolep/app-table --save
  ```

  ```html
    <link rel="import" href="bower_components/app-table/app-table.html">

    <app-table>
      <table>
        <col label="h1">
        <col label="header2">
        <col label="">
        <col label="very long header three">
      </table>
    </app-table>
  ```

  ### Columns

  ```<app-table>``` expects an embedded HTML5 ``<table>`` to be given as its content. Its columns are expected to be defined via HTML5 ``<col>`` elements with following attributes:

    - ``label``

  ### Data
  ``<app-table>`` expects an array of records (each records is turn an array) being set via its ``data`` attribute as follows:

  ```html
    <app-table data='[[43.31,"20156-08-30","world",null]]'>
      <table>
        <col label="h1">
        <col label="header2">
        <col label="">
        <col label="very long header three">
      </table>
    </app-table>

  ```

  or using Javascript as follows:

  ```javascript
    document.querySelector('app-table')
      .data = [
        [13.24,'2015-12-24',null,'hello'],
        [43.31,'20156-08-30','world',null]
      ];
  ```


  @demo
-->
<dom-module id="app-table">

<template>
  <style>
    :host {
      display: block;
    }

    :host .scrolltable {
      overflow-x: scroll;
      height: 100%;
      display: flex;
      display: -webkit-flex;
      flex-direction: column;
      -webkit-flex-direction: column;
    }

    :host .scrolltable > .header {
    }

    :host .scrolltable > .body {
      /*noinspection CssInvalidPropertyValue*/
      width: -webkit-fit-content;
      overflow-y: scroll;
      flex: 1;
      -webkit-flex: 1;
    }
  </style>

  <div class="scrolltable">
    <content select="table">

    </content>
    <div class="body">
      <table class="table">
        <tbody></tbody>
      </table>
    </div>
  </div>
</template>

<script>
;!function() {

  var tooEarly = true;

  var pending;


  var cols = [];


  var append = function(tagName, parent) {
    var e = document.createElement(tagName);
    parent.appendChild(e);
    return e;
  };


  var removeIfExists = function(el, parent) {
    if (el) {
      parent.removeChild(el);
    }
  };


  var tableHeader = function(appTable) {
    var contentChildren = appTable.getContentChildren();
    if (contentChildren.length > 0) {
      // TODO remove additional tables that might have been given in content
      return contentChildren[0];
    }
    else {
      throw '<app-table> expects a <table> to be wrapped';
    }
  };


  var tableBody = function(appTable) {
    return Polymer.dom(appTable.root).querySelector('.body table');
  };


  var minWidth = function() {
    // TODO why 200? Could it depend on Twitter Bootstrap?
    return this.editable ? 0 : 0;
  };


  var reset = function(appTable) {
    var table = tableHeader(appTable);
    var thead = table.querySelector('thead');
    removeIfExists(thead, table);

    thead = append('thead', table);
    var j, th, tr = append('tr', thead);
    for (j = 0; j < cols.length; j++) {
      th = append('th', tr);
      th.textContent = cols[j].label;
    }

    table = tableBody(appTable);
    var tbody = table.querySelector('tbody');
    removeIfExists(tbody, table);
  };


  var measure = function(appTable) {
    var theader = tableHeader(appTable).querySelectorAll('.header th');
    var tbody = tableBody(appTable).querySelectorAll('.body td');

    // determine best widths
    var i, j;
    for (j = 0; j < cols.length; j++) {

      /*
       * offsetWidth is the width of the visual box incuding all borders.
       * Can be calculated by adding width and paddings and borders
       */
      cols[j].width = theader[j].offsetWidth;

      var offsetWidth;
      for (i = 0; i < tbody.length;  i = i + cols.length) {
        offsetWidth = Math.max(tbody[i + j].offsetWidth, cols[j].minWidth()) ;
        if (cols[j].width < offsetWidth) {
          cols[j].width = offsetWidth;
        }
        // no reason to iterate all over the table.body
        break;
      }
    }

    // apply best widths
    var width;
    for (j = 0; j < cols.length; j++) {
      width = cols[j].width + 'px';
      theader[j].style.minWidth = width;

      for (i = 0; i < tbody.length;  i = i + cols.length) {
        tbody[i + j].style.minWidth = width;
        // no reason to iterate all over the table.body
        break;
      }
    }
  };


  var update = function(appTable, data) {
    reset(appTable);

    var table = tableBody(appTable);
    var tbody = table.querySelector('tbody');

    if (data && data.length > 0) {
      tbody = append('tbody', table);

      var i, tr, j, td;
      for (i = 0; i < data.length; i++) {
        var record = data[i];
        tr = append('tr', tbody);

        for (j = 0; j < cols.length; j++) {
          td = append('td', tr);
          td.textContent = record[j] || '';
        }
      }
      measure(appTable);
    }
  };


  Polymer({
    is: 'app-table',

    properties: {
      /**
       * The data being set
       */
      data: {
        type: Array,
        value: function() { return []; },
        observer: '_update'
      }
    },

    _update: function(newValue, oldValue) {
      if (tooEarly) {
        pending = [newValue, oldValue];
      }
      else if (newValue && newValue !== oldValue) {
        update(this, newValue);
      }
    },



    ready: function() {
      var table = tableHeader(this);
      table.classList.add('header');

      // query its cols instead
      var thead, colEls = table.querySelectorAll('col');
      if (colEls.length > 0) {
        thead = append('thead', table);
        var tr = append('tr', thead);

        var i = 0, col;
        for (; i < colEls.length; i++) {
          col = Object.create(null);
          col.label = colEls[i].getAttribute('label');
          col.minWidth = minWidth;
          cols.push(col);
        }

        reset(this);
      }
      else {
        throw '<app-table> expects <table><col> elements'
      }
    },


    // var scrolltable = Polyer.dom(this.root).querySelector('.scrolltable');
    attached: function() {
      tooEarly = false;
      this._update(pending[0], pending[1]);
    }
  });
}();
</script>
</dom-module>
